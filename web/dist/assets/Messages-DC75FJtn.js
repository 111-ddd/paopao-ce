import{d as E,c as T,l as me,f as a,j as i,q as n,w as t,bq as o,k as w,A,G as p,z as g,Z as _,t as z,s as ge,h as H,x as se,F as ne,r as v,b as fe}from"./@vue-CT9fXtKS.js";import{u as te}from"./vuex-BtQJPySv.js";import{u as ve,b as ke}from"./vue-router-Oso6ZnuY.js";import{K as ye,P as we,Q as he,R as be,u as $e,f as Ce,_ as J,S as Ie,T as Me}from"./index-CEQM3iaT.js";import{K as x,k as Se,N as qe,O as ze,Q as ee,U as Oe,r as B,s as Re,t as Ae,X as F,Y as Fe,Z as W,_ as V,R as D}from"./@vicons-BcP-CCNH.js";import{F as Te,i as m,n as Be,M as Ne,k as Pe,B as ae,P as oe,T as Ue,O as je,U as We,a as Ve,G as De,Q as He,J as Qe,j as Ge,H as Ke}from"./naive-ui-1pzJR9kY.js";import{_ as Ye}from"./whisper-C90jedry.js";import{_ as Ze}from"./main-nav.vue_vue_type_style_index_0_lang-tx84Ctyj.js";import{Y as Ee}from"./v3-infinite-loading-DLisiGa3.js";import"./axios-upsvKRUO.js";import"./moment-P60zs0je.js";/* empty css               */import"./seemly-96Y8tuX4.js";import"./vueuc-rMdi6pp7.js";import"./evtd-CI_DDEu_.js";import"./@css-render-D-71Ub-V.js";import"./vooks-D483k878.js";import"./vdirs-Bxp-63WN.js";import"./@juggle-DY95s5UV.js";import"./css-render-wuhQizsj.js";import"./@emotion-WldOFDRm.js";import"./lodash-es-BI2Xm8S2.js";import"./treemate-N4GG0L_2.js";import"./async-validator-P8scd9xB.js";import"./date-fns-Db9XENWt.js";const Je={class:"sender-wrap"},Le={key:0,class:"nickname"},Xe={key:0,class:"username"},xe={key:1,class:"nickname"},es={key:0,class:"username"},ss={key:2,class:"nickname"},ns={class:"timestamp"},ts={class:"timestamp-txt"},as={key:0,class:"brief-content"},os={key:1,class:"whisper-content-wrap"},ls={key:2,class:"requesting-friend-wrap"},rs={key:2,class:"status-info"},is={key:3,class:"status-info"},us="https://assets.paopao.info/public/avatar/default/admin.png",cs=E({__name:"message-item",props:{message:{}},emits:["send-whisper","reload"],setup(Q,{emit:h}){const N=ve(),c=te(),f=Te(),u=Q,b=e=>()=>H(m,null,{default:()=>H(e)}),$=T(()=>{let e=u.message.type==4&&u.message.sender_user_id==c.state.userInfo.id?u.message.receiver_user:u.message.sender_user,s=[{label:"私信 @"+e.username,key:"whisper",icon:b(B)}];return c.state.userInfo.id!=e.id&&(e.is_following?s.push({label:"取消关注 @"+e.username,key:"unfollow",icon:b(Re)}):s.push({label:"关注 @"+e.username,key:"follow",icon:b(Ae)})),s}),d=h,k=e=>{let s=e.type==4&&e.sender_user_id==c.state.userInfo.id?e.receiver_user:e.sender_user;f.success({title:"提示",content:"确定"+(s.is_following?"取消关注 @":"关注 @")+s.username+" 吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{s.is_following?$e({user_id:s.id}).then(y=>{window.$message.success("操作成功"),s.is_following=!1,setTimeout(()=>{d("reload")},50)}).catch(y=>{}):Ce({user_id:s.id}).then(y=>{window.$message.success("关注成功"),s.is_following=!0,setTimeout(()=>{d("reload")},50)}).catch(y=>{})}})},O=e=>{switch(e){case"whisper":const s=u.message;if(s.type!=99){let y=s.type==4&&s.sender_user_id==c.state.userInfo.id?s.receiver_user:s.sender_user;d("send-whisper",y)}break;case"follow":case"unfollow":k(u.message);break}},C=T(()=>u.message.type!==4||u.message.sender_user_id!==c.state.userInfo.id),P=T(()=>u.message.type==4&&u.message.receiver_user_id==c.state.userInfo.id),R=T(()=>u.message.type==4&&u.message.sender_user_id==c.state.userInfo.id),r=e=>{S(e),(e.type===1||e.type===2||e.type===3)&&(e.post&&e.post.id>0?N.push({name:"post",query:{id:e.post_id}}):window.$message.error("该动态已被删除"))},G=e=>{S(e),we({user_id:e.sender_user_id}).then(s=>{e.reply_id=2,window.$message.success("已同意添加好友")}).catch(s=>{console.log(s)})},U=e=>{S(e),he({user_id:e.sender_user_id}).then(s=>{e.reply_id=3,window.$message.success("已拒绝添加好友")}).catch(s=>{console.log(s)})},S=e=>{u.message.receiver_user_id==c.state.userInfo.id&&e.is_read===0&&be({id:e.id}).then(s=>{e.is_read=1}).catch(s=>{console.log(s)})};return(e,s)=>{const y=Be,j=me("router-link"),I=Ne,K=Pe,l=ae,q=oe,Y=Ue,Z=je;return a(),i("div",{class:ge(["message-item",{unread:C.value&&e.message.is_read===0}]),onClick:s[5]||(s[5]=M=>S(e.message))},[n(Z,{"content-indented":""},{avatar:t(()=>[n(y,{round:"",size:30,src:e.message.type==4&&e.message.sender_user_id==o(c).state.userInfo.id?e.message.receiver_user.avatar:e.message.sender_user.id>0?e.message.sender_user.avatar:us},null,8,["src"])]),header:t(()=>[w("div",Je,[e.message.type!=4&&e.message.sender_user.id>0||P.value?(a(),i("span",Le,[n(j,{onClick:s[0]||(s[0]=A(()=>{},["stop"])),class:"username-link",to:{name:"user",query:{s:e.message.sender_user.username}}},{default:t(()=>[p(g(e.message.sender_user.nickname),1)]),_:1},8,["to"]),o(c).state.desktopModelShow?(a(),i("span",Xe," @"+g(e.message.sender_user.username),1)):_("",!0)])):R.value?(a(),i("span",xe,[n(j,{onClick:s[1]||(s[1]=A(()=>{},["stop"])),class:"username-link",to:{name:"user",query:{s:e.message.receiver_user.username}}},{default:t(()=>[p(g(e.message.receiver_user.nickname),1)]),_:1},8,["to"]),o(c).state.desktopModelShow?(a(),i("span",es," @"+g(e.message.receiver_user.username),1)):_("",!0)])):(a(),i("span",ss," 系统 ")),R.value?(a(),z(I,{key:3,class:"top-tag",type:"info",size:"small",round:""},{icon:t(()=>[n(o(m),{component:o(x)},null,8,["component"])]),default:t(()=>[s[6]||(s[6]=p(" 私信已发送 "))]),_:1})):_("",!0),e.message.type==4&&e.message.receiver_user_id==o(c).state.userInfo.id?(a(),z(I,{key:4,class:"top-tag",type:"warning",size:"small",round:""},{icon:t(()=>[n(o(m),{component:o(x)},null,8,["component"])]),default:t(()=>[s[7]||(s[7]=p(" 私信已接收 "))]),_:1})):_("",!0)])]),"header-extra":t(()=>[w("span",ns,[C.value&&e.message.is_read===0?(a(),z(K,{key:0,dot:"",processing:""})):_("",!0),w("span",ts,g(o(ye)(e.message.created_on)),1),n(q,{placement:"bottom-end",trigger:"click",size:"small",options:$.value,onSelect:O},{default:t(()=>[n(l,{quaternary:"",circle:""},{icon:t(()=>[n(o(m),null,{default:t(()=>[n(o(Se))]),_:1})]),_:1})]),_:1},8,["options"])])]),description:t(()=>[n(Y,{"show-icon":!1,class:"brief-wrap",type:!C.value||e.message.is_read>0?"default":"success"},{default:t(()=>[e.message.type!=4?(a(),i("div",as,[p(g(e.message.brief)+" ",1),e.message.type===1||e.message.type===2||e.message.type===3?(a(),i("span",{key:0,onClick:s[2]||(s[2]=A(M=>r(e.message),["stop"])),class:"hash-link view-link"},[n(o(m),null,{default:t(()=>[n(o(qe))]),_:1}),s[8]||(s[8]=p(" 查看详情 "))])):_("",!0)])):_("",!0),e.message.type===4?(a(),i("div",os,g(e.message.content),1)):_("",!0),e.message.type===5?(a(),i("div",ls,[p(g(e.message.content)+" ",1),e.message.reply_id===1?(a(),i("span",{key:0,onClick:s[3]||(s[3]=A(M=>G(e.message),["stop"])),class:"hash-link view-link"},[n(o(m),null,{default:t(()=>[n(o(ze))]),_:1}),s[9]||(s[9]=p(" 同意 "))])):_("",!0),e.message.reply_id===1?(a(),i("span",{key:1,onClick:s[4]||(s[4]=A(M=>U(e.message),["stop"])),class:"hash-link view-link"},[n(o(m),null,{default:t(()=>[n(o(ee))]),_:1}),s[10]||(s[10]=p(" 拒绝 "))])):_("",!0),e.message.reply_id===2?(a(),i("span",rs,[n(o(m),null,{default:t(()=>[n(o(Oe))]),_:1}),s[11]||(s[11]=p(" 已同意 "))])):_("",!0),e.message.reply_id===3?(a(),i("span",is,[n(o(m),null,{default:t(()=>[n(o(ee))]),_:1}),s[12]||(s[12]=p(" 已拒绝 "))])):_("",!0)])):_("",!0)]),_:1},8,["type"])]),_:1})],2)}}}),ds=J(cs,[["__scopeId","data-v-019d5af4"]]),_s={class:"content"},ps=E({__name:"message-skeleton",props:{num:{default:1}},setup(Q){return(h,N)=>{const c=We;return a(!0),i(ne,null,se(new Array(h.num),f=>(a(),i("div",{class:"skeleton-item",key:f},[w("div",_s,[n(c,{text:"",repeat:2}),n(c,{text:"",style:{width:"60%"}})])]))),128)}}}),ms=J(ps,[["__scopeId","data-v-01d2e871"]]),gs={class:"title title-action"},fs={class:"title title-filter"},vs={key:0,class:"skeleton-wrap"},ks={key:1},ys={key:0,class:"empty-wrap"},ws={key:1},hs={class:"load-more-wrap"},bs={class:"load-more-spinner"},$s=E({__name:"Messages",setup(Q){const h=te(),N=ke(),c=v(!1),f=v(!1),u=v(+N.query.p||1),b=v(20),$=v(0),d=v([]),k=v("所有消息"),O=v("all"),C=v(!1),P=v({id:0,avatar:"",username:"",nickname:"",is_admin:!1,is_friend:!0,is_following:!1,created_on:0,follows:0,followings:0,status:1}),R=()=>{f.value=!1,u.value=1,$.value=0,d.value=[]},r=l=>()=>H(m,null,{default:()=>H(l)}),G=T(()=>{let l;switch(k.value){case"所有消息":l=[{label:"系统消息",key:"system",icon:r(V)},{label:"我的私信",key:"whisper",icon:r(B)},{label:"好友申请",key:"requesting",icon:r(D)},{label:"未读消息",key:"unread",icon:r(F)}];break;case"系统消息":l=[{label:"所有消息",key:"all",icon:r(W)},{label:"我的私信",key:"whisper",icon:r(B)},{label:"好友申请",key:"requesting",icon:r(D)},{label:"未读消息",key:"unread",icon:r(F)}];break;case"我的私信":l=[{label:"所有消息",key:"all",icon:r(W)},{label:"系统消息",key:"system",icon:r(V)},{label:"好友申请",key:"requesting",icon:r(D)},{label:"未读消息",key:"unread",icon:r(F)}];break;case"好友申请":l=[{label:"所有消息",key:"all",icon:r(W)},{label:"系统消息",key:"system",icon:r(V)},{label:"我的私信",key:"whisper",icon:r(B)},{label:"未读消息",key:"unread",icon:r(F)}];break;case"未读消息":l=[{label:"所有消息",key:"all",icon:r(W)},{label:"系统消息",key:"system",icon:r(V)},{label:"我的私信",key:"whisper",icon:r(B)},{label:"好友申请",key:"requesting",icon:r(D)}];break;default:l=[];break}return l}),U=l=>{switch(l){case"all":k.value="所有消息";break;case"system":k.value="系统消息";break;case"whisper":k.value="我的私信";break;case"requesting":k.value="好友申请";break;case"unread":k.value="未读消息";break}O.value=l,R(),I()},S=()=>{U("unread")},e=()=>{h.state.unreadMsgCount>0&&d.value.length>0&&Me().then(l=>{if(O.value!="unread")for(let q in d.value)d.value[q].is_read=1;else d.value=[];h.commit("updateUnreadMsgCount",0)}).catch(l=>{console.log(l)})},s=l=>{P.value=l,C.value=!0},y=()=>{C.value=!1},j=()=>{R(),I()},I=()=>{c.value=!0,Ie({style:O.value,page:u.value,page_size:b.value}).then(l=>{c.value=!1,l.list.length===0&&(f.value=!0),u.value>1?d.value=d.value.concat(l.list):(d.value=l.list,window.scrollTo(0,0)),$.value=Math.ceil(l.pager.total_rows/b.value)}).catch(l=>{c.value=!1,u.value>1&&u.value--})},K=()=>{u.value<$.value||$.value==0?(f.value=!1,u.value++,I()):f.value=!0};return fe(()=>{I()}),(l,q)=>{const Y=Ze,Z=Ye,M=ae,le=He,re=oe,L=Ve,ie=ms,ue=Qe,ce=ds,de=Ke,_e=De,pe=Ge;return a(),i("div",null,[n(Y,{title:"消息"}),n(_e,{class:"main-content-wrap messages-wrap",bordered:""},{default:t(()=>[n(Z,{show:C.value,user:P.value,onSuccess:y},null,8,["show","user"]),n(L,{justify:"space-between"},{default:t(()=>[w("div",gs,[n(M,{text:"",size:"small",focusable:!1,onClick:S},{icon:t(()=>[n(o(m),null,{default:t(()=>[n(o(F))]),_:1})]),default:t(()=>[p(" "+g(o(h).state.unreadMsgCount)+" 条未读 ",1)]),_:1}),n(le,{vertical:""}),n(M,{text:"",size:"small",focusable:!1,onClick:e},{default:t(()=>q[0]||(q[0]=[p("全标已读")])),_:1})]),w("div",fs,[n(re,{placement:"bottom-end",trigger:"click",size:"small",options:G.value,onSelect:U},{default:t(()=>[n(M,{text:""},{icon:t(()=>[n(o(m),null,{default:t(()=>[n(o(Fe))]),_:1})]),default:t(()=>[p(" "+g(k.value),1)]),_:1})]),_:1},8,["options"])])]),_:1}),c.value&&d.value.length===0?(a(),i("div",vs,[n(ie,{num:b.value},null,8,["num"])])):(a(),i("div",ks,[d.value.length===0?(a(),i("div",ys,[n(ue,{size:"large",description:"暂无数据"})])):(a(),i("div",ws,[(a(!0),i(ne,null,se(d.value,X=>(a(),z(de,{key:X.id},{default:t(()=>[n(ce,{message:X,onSendWhisper:s,onReload:j},null,8,["message"])]),_:2},1024))),128))]))]))]),_:1}),$.value>0?(a(),z(L,{key:0,justify:"center"},{default:t(()=>[n(o(Ee),{class:"load-more",slots:{complete:"没有更多消息了",error:"加载出错"},onInfinite:K},{spinner:t(()=>[w("div",hs,[f.value?_("",!0):(a(),z(pe,{key:0,size:14})),w("span",bs,g(f.value?"没有更多消息了":"加载更多"),1)])]),_:1})]),_:1})):_("",!0)])}}}),Es=J($s,[["__scopeId","data-v-a2e6a3be"]]);export{Es as default};
